<!DOCTYPE html>
<html>
  <head>
    <link
      rel="shortcut icon"
      href="media/ثلاثية الإنتظار.png"
      type="image/x-icon"
    />
    <title>Quiz</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="questions.css" />
  </head>
  <script>
    document.addEventListener("visibilitychange", function () {
      if (document.visibilityState === "hidden") {
        window.location.href = "sorry.html";
      }
    });
  </script>
  <body>
    <div class="logo">
      <img src="media/ثلاثية الإنتظار.png" alt="" />
    </div>

    <div id="question"></div>

    <div id="timer"></div>

    <div id="choices"></div>

    <!-- <button id="submit">تأكيد الإجابة</button> -->

    <div id="score"></div>
    <img id="head-name" src="media/name.png" alt="" />

    <script type="module">
      const urlParams = new URLSearchParams(window.location.search);
      const name = urlParams.get("name");

      var questions = [
        {
          question: "تجربة",
          choices: [
            "الامام المهدي (عج)",
            "الامام الحسين (ع)",
            "الامام علي (ع)",
          ],
          answer: "الامام المهدي (عج)",
        },
        {
          question: "تجربة 2",
          choices: ["1", "2", "3"],
          answer: "2",
        },
      ];

      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-app.js";
      import {
        getDatabase,
        ref,
        set,
        get,
        child,
      } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-database.js";
      const firebaseConfig = {
        apiKey: "AIzaSyArDynFiDleYc0pw5vOgFVlg57SaVDaodc",
        authDomain: "shaaban-d84b3.firebaseapp.com",
        databaseURL: "https://shaaban-d84b3-default-rtdb.firebaseio.com",
        projectId: "shaaban-d84b3",
        storageBucket: "shaaban-d84b3.appspot.com",
        messagingSenderId: "832596226414",
        appId: "1:832596226414:web:512c00862816419f2d517f",
      };

      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);

      var numQuestions = 30;

      var pointsPerAnswer = 2;

      var currentQuestion = 0;
      var score = 0;

      var displayedQuestions = [];

      var timer = null;
      var timeLeft = 3;

      function startTimer() {
        timeLeft = 3;
        timer = setInterval(function () {
          document.getElementById("timer").innerHTML = timeLeft;
          timeLeft--;
          if (timeLeft < 0) {
            clearInterval(timer);
            checkAnswer();
          }
        }, 1000);
      }

      function stopTimer() {
        clearInterval(timer);
        document.getElementById("timer").innerHTML = "";
      }

      function displayQuestion() {
        if (displayedQuestions.length === questions.length) {
          stopTimer();
          document.getElementById("question").innerHTML = "انتهت المسابقة !";
          document.getElementById("choices").innerHTML = "";
          document.getElementById("choices").style.display = "none";
          document.getElementById("timer").style.display = "none";
          document.getElementById("score").innerHTML =
            "حظا موفقا " + name + "\n\n" + "رصيدك : " + score + " نقاط";
          set(ref(db, "players/" + name), {
            name: name,
            score: score,
          });
          return;
        }

        var randomQuestion;
        do {
          randomQuestion =
            questions[Math.floor(Math.random() * questions.length)];
        } while (displayedQuestions.indexOf(randomQuestion) !== -1);

        displayedQuestions.push(randomQuestion);

        document.getElementById("question").innerHTML = randomQuestion.question;

        var choicesHTML = "";
        for (var i = 0; i < randomQuestion.choices.length; i++) {
          choicesHTML +=
            "<input type='radio' name='choice' value='" +
            randomQuestion.choices[i] +
            "'>" +
            randomQuestion.choices[i] +
            "<br>";
        }
        document.getElementById("choices").innerHTML = choicesHTML;

        startTimer();
      }

      function checkAnswer() {
        stopTimer();

        var selectedAnswer = document.querySelector(
          'input[name="choice"]:checked'
        );
        var correctAnswer = displayedQuestions[currentQuestion].answer;

        if (selectedAnswer && selectedAnswer.value === correctAnswer) {
          score += pointsPerAnswer;
        }

        currentQuestion++;

        if (currentQuestion < numQuestions) {
          displayQuestion();
        } else {
          document.getElementById("question").innerHTML = "انتهت المسابقة !";
          document.getElementById("choices").innerHTML = "";
          document.getElementById("choices").style.display = "none";
          document.getElementById("timer").style.display = "none";
          document.getElementById("score").innerHTML =
            "حظا موفقا " + name + "\n\n" + "رصيدك : " + score + " نقاط";
        }
      }

      function checkTimer() {
        if (timeLeft === 0) {
          callback();
        } else {
          setTimeout(function () {
            checkTimer(timeLeft, callback);
          }, 100); // wait for 100ms before checking again
        }
      }
      checkTimer(timeLeft, function () {
        checkAnswer();
      });
      displayQuestion();

      document.getElementById("submit").addEventListener("click", checkTimer);
    </script>
  </body>
</html>
